name: Deploy PR Preview

on:
  workflow_run:
    workflows: [ci]
    types: [completed]

jobs:
  deploy-preview:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      deployments: write
      actions: read
    steps:
      - uses: actions/checkout@v5

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.workflow_run.pull_requests[0];
            if (!pr) {
              core.setFailed('No PR associated with this workflow run');
              return;
            }
            core.setOutput('number', pr.number);
            core.setOutput('head_sha', pr.head.sha);

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-preview-${{ steps.pr.outputs.number }}
          path: ./preview-build
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Start deployment
        uses: bobheadxi/deployments@v1
        id: deployment
        with:
          step: start
          token: ${{ secrets.GITHUB_TOKEN }}
          env: pr-${{ steps.pr.outputs.number }}
          ref: ${{ steps.pr.outputs.head_sha }}

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./preview-build
          destination_dir: pr-preview/pr-${{ steps.pr.outputs.number }}
          keep_files: true

      - name: Finish deployment
        uses: bobheadxi/deployments@v1
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          env: pr-${{ steps.pr.outputs.number }}
          status: success
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
          env_url: https://nannou-org.github.io/gantz/pr-preview/pr-${{ steps.pr.outputs.number }}/
