name: Deploy PR Preview

on:
  workflow_run:
    workflows: [ci]
    types: [completed]

jobs:
  deploy-preview:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      deployments: write
      actions: read
    steps:
      - uses: actions/checkout@v5

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          pattern: pr-preview-*
          path: ./preview-build
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          merge-multiple: true

      - name: Get PR info
        id: pr
        run: |
          PR_NUMBER=$(cat ./preview-build/PR_NUMBER)
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "head_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          rm ./preview-build/PR_NUMBER

      - name: Start deployment
        uses: bobheadxi/deployments@v1
        id: deployment
        with:
          step: start
          token: ${{ secrets.GITHUB_TOKEN }}
          env: pr-${{ steps.pr.outputs.number }}
          ref: ${{ steps.pr.outputs.head_sha }}

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./preview-build
          destination_dir: pr-preview/pr-${{ steps.pr.outputs.number }}
          keep_files: true

      - name: Finish deployment
        uses: bobheadxi/deployments@v1
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          env: pr-${{ steps.pr.outputs.number }}
          status: success
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
          env_url: https://nannou-org.github.io/gantz/pr-preview/pr-${{ steps.pr.outputs.number }}/
